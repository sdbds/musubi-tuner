# Musubi Tuner へのコントリビューション

Musubi Tuner 開発へのご支援、ご協力に感謝いたします。コミュニティからの開発へ手助けは、このプロジェクトにとって不可欠です。このドキュメントでは、コントリビューションの方法やプロジェクトへの参加方法について説明します。

## 目次

- [はじめに](#はじめに)
- [ご協力いただく前に](#ご協力いただく前に)
- [プロジェクトへの協力の方法](#プロジェクトへの協力の方法)
  - [問題の報告](#問題の報告)
  - [機能の提案](#機能の提案)
  - [コードのコントリビューション](#コードのコントリビューション)
- [開発環境のセットアップ](#開発環境のセットアップ)
- [コードスタイルとガイドライン](#コードスタイルとガイドライン)
- [テスト](#テスト)
- [プルリクエストのプロセス](#プルリクエストのプロセス)
- [ライセンスと帰属（Attribution）](#ライセンスと帰属attribution)
- [コミュニティとサポート](#コミュニティとサポート)

## はじめに

開発にご協力いただく前に以下をお願いします：

1. このドキュメントを読む
2. [README.md](README.md) でプロジェクトを理解する
3. [既存の Issue](https://github.com/kohya-ss/musubi-tuner/issues) と [ディスカッション](https://github.com/kohya-ss/musubi-tuner/discussions) を確認する
4. 開発環境をセットアップする

## ご協力いただく前に

### ご留意いただきたい点

- このプロジェクトのメンテナンスは限られた時間とリソースで行われています
- PRのレビューとマージには時間がかかる場合があります
- プロジェクトが成長する過程で破壊的変更が発生する可能性があります
- 質問や一般的な議論には [GitHub Discussions](https://github.com/kohya-ss/musubi-tuner/discussions) をご利用ください
- バグ報告や機能要求には [GitHub Issues](https://github.com/kohya-ss/musubi-tuner/issues) をご利用ください

### ご協力いただける例

- バグ修正
- パフォーマンスの改善
- ドキュメントの改善
- 新機能の追加（事前にディスカッションを行うことを推奨）
- コード品質の改善

## プロジェクトへの協力の方法

### 問題の報告

新しい Issue を作成する前に：

1. **既存の Issue を検索**して重複を避けてください
2. **ディスカッションを確認**して、質問が既に回答されていないか確認してください

バグ報告を作成する際は以下を含めてください：

- **明確で内容を適切に要約したタイトル**
- **問題の詳細な説明**
- **問題を再現する手順**
- **環境の詳細**：
  - オペレーティングシステム
  - GPU モデルと VRAM
  - Python バージョン
  - PyTorch バージョン
  - CUDA バージョン
- **エラーメッセージやログ**
- **期待される動作と実際の動作**
- **スクリーンショットや動画**（必要な場合）

### 機能の提案

機能要求の場合：

1. **まず Issue を開いて**機能について議論してください
2. **機能が解決する問題を説明**します
3. **提案された解決策を説明**します
4. **代替案とそのトレードオフ**を検討してください
5. **実装前にフィードバックを待つ**ことをお願いします（PRがマージされない可能性は常にあります）

重要な機能については、まず [GitHub Discussions](https://github.com/kohya-ss/musubi-tuner/discussions) にコミュニティの意見を求めることを検討してください。

### コードのコントリビューション

1. **Issue を開いて**提案する変更について議論をお願いします（些細な修正ではない場合）
2. **重要な変更の作業を開始する前に承認を待つ**ことをお願いします
3. **リポジトリをフォーク**して機能ブランチを作成する
4. **コードスタイルガイドライン**に従って変更を行う
5. **変更を徹底的にテスト**する
6. **プルリクエストを提出**する

## 開発環境のセットアップ

### 前提条件

- Python 3.10 以上
- Git
- CUDA 対応 GPU（GPU 機能のテスト用）
- 12GB 以上の VRAM 推奨

### インストール

1. **リポジトリをフォークしてクローン**：
   ```shell
   git clone https://github.com/your-username/musubi-tuner.git
   cd musubi-tuner
   ```

2. **開発環境をセットアップ**：

   **オプション A: pip を使用**
   ```shell
   # 仮想環境を作成
   python -m venv .venv

   # 仮想環境をアクティベート
   # Windows の場合:
   .venv/Scripts/activate
   # Linux/Mac の場合:
   source .venv/bin/activate

   # PyTorch をインストール（CUDA バージョンに合わせて調整）
   pip install torch torchvision --index-url https://download.pytorch.org/whl/cu128

   # パッケージを開発モードでインストール
   pip install -e .

   # 開発依存関係をインストール
   pip install --group dev
   ```

	**オプション B: uv を使用**
   ```shell
   # uv がインストールされていない場合はインストール
   curl -LsSf https://astral.sh/uv/install.sh | sh  # Linux/Mac
   # または
   powershell -c "irm https://astral.sh/uv/install.ps1 | iex"  # Windows

   # 依存関係をインストール
   uv sync --extra cu128  # または CUDA バージョンにより cu124
   ```

3. **Accelerate を設定**：
   ```shell
   accelerate config
   ```

## コードスタイルとガイドライン

### Python コードスタイル

このプロジェクトは **Ruff** をコード解析（リンティング）とコード整形に使用しています：

- **行の長さ**: 132 文字
- **インデント**: 4 スペース
- **クォートスタイル**: ダブルクォート
- **対象 Python バージョン**: 3.10

### IDE のセットアップ

https://docs.astral.sh/ruff/editors/setup/

### コード解析、整形の実行

```shell
# コードスタイルと潜在的な問題をチェック
ruff check

# 可能な場合は自動修正
ruff check --fix

# コードをフォーマット（注: フォーマットには black ではなく ruff を使用してください）
ruff format src
```

### コードガイドライン

- **コードベースの既存パターン**に従う
- **明確で説明的な変数名**を書く
- **適切な場所で型ヒント**を追加する
- **関数を単一の機能で適度なサイズ**に保つ
- **パブリック関数とクラスにドキュメント文字列**を追加する
- **エラーを適切に処理**: 回復不可能なエラーはそのままエラーとし、適切な対応が可能なエラーのみをキャッチして処理する

### インポートの整理

- 標準ライブラリのインポートを最初に
- サードパーティのインポートを次に
- ローカルインポートを最後に
- 可能な限り絶対インポートを使用

### コード修正ガイドライン

既存のコードを扱う場合：

- **既存のインターフェースとの互換性を維持**する
- **既存のモジュール構造に従う**
- **`docs/` ディレクトリの関連ドキュメントを更新**する
- **変更が複数のシステムに影響する場合、能力があれば異なるアーキテクチャでテスト**する

アーキテクチャ固有のコード（HunyuanVideo、Wan2.1/2.2、FramePack、FLUX.1 Kontext、Qwen-Image）を扱う場合：

- **命名規則に従う**: 新しいアーキテクチャを追加する場合は `{arch}_train_network.py` と `{arch}_generate_{type}.py` の命名パターンに従う
- **アーキテクチャ間の影響を考慮する**: アーキテクチャ間で共有されるコードを変更する場合
- **他のアーキテクチャでのテスト**: 変更が他のアーキテクチャに影響する場合、可能であればそれらでもテストする

## テスト

### テストの実行

```shell
# コード品質チェックを実行
ruff check

# コードをフォーマット
ruff format src

# 関連するスクリプトで変更を手動テスト
```

### 手動テストガイドライン

このプロジェクトは機械学習モデルを扱っています。そのため：

1. **まず小さなデータセット**で始めてください
2. **メモリ使用量が期待する範囲内**であることを確認してください
3. **可能であれば異なる GPU 構成**でテストをお願いします
4. **生成/訓練機能の出力品質**を検証してください

## プルリクエストのプロセス

### 提出前

1. **当該ブランチが最新のメインブランチと同期**していることを確認してください
2. **コード品質ツールを実行**：
   ```shell
   ruff check --fix
   ruff format src
   ```
3. **変更を徹底的にテスト**します
4. **必要に応じてドキュメントを更新**してください
5. **明確なコミットメッセージ**を書いてください

### プルリクエストテンプレート

PR を作成する際は以下を含めてください：

- **変更を説明する明確なタイトル**
- **何が変更されたか、なぜかの説明**
- **Issue への参照**（例：「Closes #123」）
- **実行されたテスト**
- **破壊的変更**（もしある場合）
- **ドキュメントの更新**（もしある場合）

### レビュープロセス

- メンテナーは時間があるときに PR をレビューします
- 限られたリソースのためレビューに時間がかかる場合がありますが、ご了承ください
- フィードバックに建設的に対処してください
- 議論を集中的かつ専門的に保つようお願いします

## ライセンスと帰属（Attribution）

### 帰属の要件

他のプロジェクトから派生または着想を得たコードを追加する場合：

1. **新しいファイルに適切なライセンスヘッダー**を追加する
2. **コピー/修正されたコードに帰属コメント**を含める
3. 新しいアーキテクチャのために**新しいライセンス要求を導入する場合は README.md の LICENSE セクションを更新**する
4. **プルリクエストの説明で参照元を文書化**する

### サードパーティのコード

あなたのコントリビューションにサードパーティのコードが含まれる場合：

1. **プロジェクトとのライセンス互換性を確保**する
2. **元のライセンスファイルまたはヘッダーを含める**
3. **ソースとライセンスを明確に文書化**する。プルリクエストの説明にも記載してください
4. **ソースライセンスからのすべての義務を履行**する

## コミュニティとサポート

### 情報交換の手段

- **GitHub Discussions**: 一般的な質問、アイデア、コミュニティの交流
- **GitHub Issues**: バグ報告と機能要求
- **Pull Requests**: コード貢献とレビュー

### 何かわからないことがあれば

内容に応じて以下の方法で質問してください：

- **ソフトウェアの使用法など**: [GitHub Discussions](https://github.com/kohya-ss/musubi-tuner/discussions) をチェックしてください
- **開発環境のセットアップ**: 「question」ラベルで Issue を作成してするか、ディスカッションで質問してください
- **コントリビューションのプロセス**: このガイドを参照するか、ディスカッションで質問してください

### ご協力いただいた方への謝辞など

ご協力いただいた方は以下の方法等でご紹介させていただきます：

- **Git コミット履歴**
- **重要なコントリビューションのリリースノート**
- **主要な機能への README での謝辞**

---

## 最終に

Musubi Tuner へのご協力に興味をお持ちいただき、ありがとうございます。このプロジェクトはコミュニティのご支援、ご協力で成り立っています。

以下についてご留意いただければ幸いです：

- **最初のコントリビューションは小さく**始めることをお勧めします
- **何か不明な点があれば質問**してください
- **レビュープロセスは辛抱強く**お待ちいただければ幸いです
- **ツールの構築と改善に一緒に取り組めればと**考えています

皆様のMusubi Tuner へのご協力に重ねて感謝申し上げます。