※このファイルはGUIの実装方針をAI Agentに説明するためのドキュメントです。

## GUIの実装方針

Musubi Tunerの学習スクリプトの、非常にシンプルなGUIを実装します。対象ユーザーのレベルは、Python、gitとuvはインストール、起動できるが、仮想環境 (venv) の作成、起動はちょっと難しい、くらいを想定します。

### GUIの実装

`src/musubi_tuner/gui` フォルダに `gui.py` を配置します。Gradioを使用します。

起動は `uv run gui` 等で行います（PyTorchやCUDAバージョンの考慮など、オプション等を別途検討）。

### GUIの構成

単純なひとつの画面のみで構成し、上から下に、順に作業の手順にあわせて配置します。

1. プロジェクト設定

プロジェクトフォルダを指定します。プロジェクトフォルダについては後述。

この時点で`training`フォルダを（もし存在しなければ）自動的に作成します。

2. モデルアーキテクチャの選択とモデルディレクトリ選択

Qwen-Image、Z-Image-Turboなどのモデルアーキテクチャを選択します。最初は画像生成モデルのみ対応を予定し、Z-Image-TurboとQwen-Imageを対象に実装します。

また学習時の推奨パラメータ等を適切に設定するため、VRAMサイズを選択します。

モデルディレクトリは、ComfyUI の `models` フォルダをユーザーに指定してもらいます。

3. データセット設定

学習解像度等を指定しデータセット設定ファイルを作成します。

学習解像度はモデルに応じた推奨解像度を自動設定するボタンを用意します。解像度以外は、バッチサイズのみ指定可能とします。

4. 前処理

学習データの前処理、具体的にはlatentの事前キャッシュと、text encoderの事前キャッシュを行います。モデルに応じたデフォルトのパスを指定するボタンを用意します。

5. 学習

いくつかのパラメータを指定し、学習を開始します。

- LoRA出力名
- 学習率
- 学習エポック数
- 何エポックごとに保存するか（サンプル画像生成も同じタイミング）
- Discrete Flow Shiftの値
- Block Swapを有効にするか、有効にする場合のブロック数
- 任意指定のコマンドライン引数

※ 学習のバッチサイズはデータセット設定で指定済み。

各パラメータについて、モデルとVRAMサイズに応じた推奨値を自動設定するボタンを用意します。

進捗管理は行わず、プロセスの死活監視だけ行います。進捗の確認はユーザーにコマンドプロンプトのウィンドウで確認してもらいます。

6. ポスト処理

ComfyUI用へのLoRA変換などを必要に応じて行います。デフォルトのパスを指定するボタンを用意します。

### プロジェクトフォルダの構成

簡単にするため、プロジェクトフォルダ内の設定ファイル名、サブフォルダ名はすべて固定します。

```
+ training : 学習用画像を配置するフォルダ、GUIスクリプトが自動作成します。
+ cache : latentとtext encoderの事前キャッシュを配置するフォルダ（キャッシュ処理で自動的に作成されます）
+ models : 学習結果のLoRAモデルが配置されるフォルダ（学習開始で自動的に作成されます）
    + sample : Musubi Tunerが学習中のサンプル生成画像を出力するフォルダ
+ dataset_config.toml : データセット設定ファイル、GUIスクリプトが自動作成します。
+ musubi_project.toml : GUIのプロジェクト設定（選択したモデルや解像度など）を保存するファイル。
```

`training`フォルダには、Musubi Tunerの形式、つまり画像 (\*.jpg/pngなど)  ＋ キャプションファイル（basenameが同じで、拡張子が.txt）を、ユーザーが配置します。データセット設定のステップで存在確認を行い、なければエラー表示します。

### プロジェクト設定の保存

`musubi_project.toml` に以下の項目等を保存し、次回読み込み時に復元します。

- 選択したモデルアーキテクチャ (`model_arch`)
- ComfyUIモデルディレクトリ (`comfy_models_dir`)
- 解像度 (`resolution_w`, `resolution_h`)
- バッチサイズ (`batch_size`)

これにより、プロジェクトを開き直した際もスムーズに作業を再開できます。

### モデル、VRAMサイズに応じた推奨値等の管理

`config_manager.py` に、モデル、VRAMサイズに応じた推奨値等を管理するクラスを実装します。

### 国際化 (Internationalization / i18n)

GradioのI18n機能 (`gr.I18n`) を使用して、GUIのテキストを多言語対応（英語・日本語）します。
`i18n` 辞書に言語ごとのテキストを定義し、GUI構築時に参照するようにします。
ユーザーのブラウザ設定などに基づいて言語が切り替わる想定です。
